name: CI

on: [push, pull_request]

jobs:
  build_test_build_release:
    strategy:
      fail-fast: false
      matrix:
        target: [windows-x86, windows-x64, ubuntu, macos]
        include:
          # We're using static linking on Windows for the tests
          # because it uses C++ API which is not properly supported yet
          - target: windows-x86
            vm: windows-latest
            triplet: x86-windows-dynamic-release
            cmake_platform_flag: "-A Win32"
            test_link_static: "true"
          - target: windows-x64
            vm: windows-latest
            triplet: x64-windows-dynamic-release
            cmake_platform_flag: "-A x64"
            test_link_static: "true"
          - target: ubuntu
            vm: ubuntu-latest
            triplet: x64-linux-dynamic-release
            cmake_platform_flag: ""
            test_link_static: "false"
          - target: macos
            vm: macos-latest
            triplet: x64-osx-dynamic-release
            cmake_platform_flag: ""
            test_link_static: "false"
    runs-on: ${{ matrix.vm }}
    defaults:
      run:
        shell: bash
    env:
      VCPKG_DEFAULT_TRIPLET: ${{ matrix.triplet }}
    steps:
      - uses: actions/checkout@v2.1.0
        with:
          submodules: true
      # Install our C/C++ library dependencies
      # and test support libraries:
      - uses: actions/cache@v1
        id: cache-vcpkg
        with:
          key: vcpkg-${{ matrix.target }}-v2
          path: vcpkg/
      - run: |
          mkdir -p ./vcpkg
          cp -a $VCPKG_INSTALLATION_ROOT/. ./vcpkg/
          ./vcpkg/vcpkg install \
            --overlay-triplets=misc/vcpkg_custom_triplets \
            freetype[png] harfbuzz[ucdn] icu ms-gsl catch2 \
            boost-container-hash
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
      - uses: actions/cache@v1
        id: cache-uthash
        with:
          key: uthash-${{ matrix.target }}-v1
          path: lib/uthash/
      - run: |
          cd lib
          git clone https://github.com/troydhanson/uthash.git
          cd uthash
          git checkout 1124f0a70b0714886402c3c0df03d037e3c4d57a
        if: steps.cache-uthash.outputs.cache-hit != 'true'
      # Build in debug mode for testing:
      - run: |
          mkdir build
          cd build
          cmake .. -D CMAKE_BUILD_TYPE=Debug ${{ matrix.cmake_platform_flag }} \
            -D CMAKE_VERBOSE_MAKEFILE=true \
            -D COBBLETEXT_BUILD_DOCS=false \
            -D COBBLETEXT_STATIC=${{ matrix.test_link_static }} \
            -D VCPKG_TARGET_TRIPLET=$VCPKG_DEFAULT_TRIPLET \
            -D CMAKE_TOOLCHAIN_FILE=$GITHUB_WORKSPACE/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -D UTHASH_INCLUDE_PATH=$GITHUB_WORKSPACE/lib/uthash/src/
      - run: |
          cmake --build . --target test_main
          cmake --build . --target ppm_example
        working-directory: build/
      - run: ctest --verbose -C Debug
        working-directory: build/
      # Now build dynamic library:
      - run: |
          mkdir build-release
          cd build-release
          cmake .. -D CMAKE_BUILD_TYPE=Release ${{ matrix.cmake_platform_flag }} \
            -D CMAKE_VERBOSE_MAKEFILE=true \
            -D COBBLETEXT_BUILD_DOCS=false \
            -D COBBLETEXT_BUILD_TESTS=false \
            -D COBBLETEXT_BUILD_EXAMPLES=false \
            -D VCPKG_TARGET_TRIPLET=$VCPKG_DEFAULT_TRIPLET \
            -D CMAKE_TOOLCHAIN_FILE=$GITHUB_WORKSPACE/vcpkg/scripts/buildsystems/vcpkg.cmake
      - run: |
          cmake --build . --target cobbletext
        working-directory: build-release/
      - uses: actions/upload-artifact@v1
        with:
          name: bin-${{ matrix.triplet }}
          path: build-release/bin/
      - run: >-
          ./vcpkg/vcpkg export
            --overlay-triplets=misc/vcpkg_custom_triplets \
            --raw --output=build-release/bin-dependencies/
            freetype[png] harfbuzz[ucdn] icu
      - uses: actions/upload-artifact@v1
        with:
          name: bin-dependencies-${{ matrix.triplet }}
          path: build-release/bin-dependencies/
